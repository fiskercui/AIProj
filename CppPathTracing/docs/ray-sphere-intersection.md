# 光线-球体相交原理详解

## 📐 基本概念

### 光线方程
光线是从一个起点出发，沿着某个方向延伸的射线。数学表示为：

```
P(t) = O + t * D
```

其中：
- **P(t)** = 光线上距离起点 t 单位的点
- **O** = 光线起点 (Origin)
- **D** = 光线方向 (Direction)
- **t** = 参数（t >= 0 表示从起点向前）

### 球体方程
球体是所有与中心点距离等于半径的点的集合：

```
(P - C) · (P - C) = r²
```

其中：
- **P** = 球面上的任意点
- **C** = 球心 (Center)
- **r** = 半径 (Radius)
- **·** = 点积运算

---

## 🎯 求交原理

### 步骤 1: 代入光线方程

将光线方程 `P(t) = O + t * D` 代入球体方程：

```
(O + t*D - C) · (O + t*D - C) = r²
```

### 步骤 2: 简化为二次方程

令 `OC = O - C` (从球心到光线起点的向量)，展开上式：

```
(OC + t*D) · (OC + t*D) = r²
(OC · OC) + 2t(OC · D) + t²(D · D) = r²
```

整理成标准二次方程形式：

```
at² + bt + c = 0
```

其中：
- **a** = D · D （方向向量的长度平方）
- **b** = 2(OC · D)
- **c** = OC · OC - r² （光线起点到球心距离的平方减去半径平方）

### 步骤 3: 使用判别式判断相交情况

二次方程的判别式：

```
Δ = b² - 4ac
```

**三种情况：**

1. **Δ < 0** 
   - 无实数解
   - 光线**没有**击中球体
   
2. **Δ = 0**
   - 一个实数解
   - 光线**恰好擦过**球体（相切）
   
3. **Δ > 0**
   - 两个实数解
   - 光线**穿过**球体（入射点和出射点）

### 步骤 4: 计算交点

如果 Δ ≥ 0，使用求根公式：

```
t = (-b ± √Δ) / 2a
```

会得到两个解：
- **t₁ = (-b - √Δ) / 2a** - 近交点（光线进入球体）
- **t₂ = (-b + √Δ) / 2a** - 远交点（光线离开球体）

我们通常只需要**最近的正值交点**（t > 0）。

---

## 💻 代码实现分析

让我们看看 `sphere.h` 中的实现：

```cpp
bool Sphere::hit(const Ray& r, double t_min, double t_max, HitRecord& rec) const {
    // 步骤1: 计算 OC 向量
    Vec3 oc = r.origin - center;
    
    // 步骤2: 计算二次方程系数
    double a = dot(r.direction, r.direction);
    double half_b = dot(oc, r.direction);  // 注意：这里用 half_b 优化
    double c = dot(oc, oc) - radius * radius;
    
    // 步骤3: 计算判别式
    double discriminant = half_b * half_b - a * c;
    
    if (discriminant < 0) {
        return false;  // 无交点
    }
    
    // 步骤4: 计算交点
    double sqrtd = std::sqrt(discriminant);
    
    // 找到在有效范围内的最近交点
    double root = (-half_b - sqrtd) / a;  // 近交点
    if (root < t_min || t_max < root) {
        root = (-half_b + sqrtd) / a;     // 尝试远交点
        if (root < t_min || t_max < root) {
            return false;                  // 两个交点都不在有效范围
        }
    }
    
    // 步骤5: 填充碰撞记录
    rec.t = root;
    rec.point = r.at(rec.t);              // 交点位置
    Vec3 outward_normal = (rec.point - center) / radius;  // 单位法向量
    rec.set_face_normal(r, outward_normal);
    rec.material = material;
    
    return true;
}
```

---

## 🔍 优化技巧

### 1. 使用 half_b 优化

原始公式：`b = 2(OC · D)`

优化后：`half_b = OC · D`

判别式从 `b² - 4ac` 变为 `half_b² - ac`

这样可以减少一次乘法运算。

### 2. t_min 和 t_max 范围检查

- **t_min = 0.001** - 避免"阴影痤疮"（shadow acne）
  - 防止光线与自己所在表面再次相交
  
- **t_max = infinity** - 只考虑光线前方的交点

### 3. 为什么先检查近交点？

```
光线方向 →     ●─────○─────●
              近点    远点
```

我们首先检查近交点，因为：
- 近交点是光线首先碰到的点
- 在渲染中，我们只关心最近的可见表面

---

## 📊 可视化理解

### 情况 1: 光线击中球体（Δ > 0）

```
    光线
     ↓
  O ━━━━━━━━━━→ D
           ╱  ╲
          ╱ ●  ╲
         │   C   │  ← 球体
          ╲     ╱
           ╲___╱
          ↑     ↑
         t₁    t₂
      (入射)  (出射)
```

### 情况 2: 光线擦过球体（Δ = 0）

```
  O ━━━━━━━━━━→ D
              ╱  ╲
             ╱ ●  ╲
            │   C   │  ← 光线刚好相切
             ╲     ╱
              ╲___╱
               ↑
               t
           (切点)
```

### 情况 3: 光线错过球体（Δ < 0）

```
  O ━━━━━━━━━━→ D
                    ╱  ╲
                   ╱ ●  ╲
                  │   C   │  ← 球体
                   ╲     ╱
                    ╲___╱
       (无交点)
```

---

## 🎓 法向量计算

交点处的法向量是从球心指向交点的单位向量：

```
normal = (hit_point - center) / radius
```

这个向量：
- 垂直于球面
- 长度为 1（单位向量）
- 用于后续的光照计算

---

## 🔬 实际应用示例

假设：
- 球心 C = (0, 0, -1)
- 半径 r = 0.5
- 光线起点 O = (0, 0, 0)
- 光线方向 D = (0, 0, -1)（向屏幕内）

计算过程：

1. **OC** = O - C = (0, 0, 0) - (0, 0, -1) = (0, 0, 1)

2. **系数计算**：
   - a = D·D = 0² + 0² + (-1)² = 1
   - half_b = OC·D = 0×0 + 0×0 + 1×(-1) = -1
   - c = OC·OC - r² = (0² + 0² + 1²) - 0.5² = 1 - 0.25 = 0.75

3. **判别式**：
   - Δ = (-1)² - 1×0.75 = 1 - 0.75 = 0.25 > 0 ✓（有交点）

4. **求根**：
   - √Δ = √0.25 = 0.5
   - t₁ = (1 - 0.5) / 1 = 0.5
   - t₂ = (1 + 0.5) / 1 = 1.5

5. **交点位置**：
   - 近交点：P(0.5) = (0,0,0) + 0.5×(0,0,-1) = (0, 0, -0.5)
   - 远交点：P(1.5) = (0,0,0) + 1.5×(0,0,-1) = (0, 0, -1.5)

---

## 💡 关键要点总结

1. **数学本质**：光线-球体相交问题本质上是求解二次方程

2. **判别式的意义**：
   - Δ < 0：无交点
   - Δ = 0：相切
   - Δ > 0：两个交点

3. **优化技巧**：
   - 使用 half_b 减少计算
   - 设置 t_min 避免自相交
   - 优先返回近交点

4. **法向量**：从球心指向表面的单位向量

5. **应用场景**：这是路径追踪的基础，每条光线都需要与场景中的所有球体进行此检测

---

## 🔗 扩展阅读

- **其他几何体相交**：平面、三角形、立方体
- **加速结构**：BVH、KD-Tree（减少不必要的相交测试）
- **解析几何基础**：向量运算、点积、叉积的几何意义

---

希望这个解释帮助你理解了光线-球体相交的数学原理！